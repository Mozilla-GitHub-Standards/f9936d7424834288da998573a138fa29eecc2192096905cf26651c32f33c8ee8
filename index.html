<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<!-- This Source Code Form is subject to the terms of the Mozilla Public
   - License, v. 2.0. If a copy of the MPL was not distributed with this
   - file, You can obtain one at http://mozilla.org/MPL/2.0/. -->
<HTML>
<HEAD>
	<script type="text/javascript" src="modevlib/imports/import.js"></script>
</HEAD>
<BODY style="position:relative;">

<div id="sidebar" style="width:300px;">
	<br>
	<br>
	<div style="height: 30px; text-align: center;vertical-align:middle;">
		<span id="status" style="height:30px">Page Loading...</span><span class="loading"><img src="images/spinner.gif" alt=""></span>
	</div>

	<hr>
	<div id="description">View average timings for each step in BuildBot, or MozHarness.  Filter by pool, platfrom or suite.<br><br>
	</div>
	<hr>
	<div id="testMessage"></div>
	<hr>
	<div id="stats"></div>
	<hr>
	<div id="parameters" class="parameters">
	</div>
	<div id="filters" class="menu"></div>
</div>

<div style="align:left;position:relative;float:left;width:800px;">
	<h3 id="title">Buildbot Timings (past 2 days average)</h3>

	<div id="details" style="overflow-y: scroll;position:absolute;left:10px;"></div>
	<!--<div id="chart" class="chart" style="text-align:center;width:800px;height:300px;"></div>-->
</div>
<div class="footer">
	Source at <a href="https://github.com/mozilla/MoBuildbotTimings">https://github.com/mozilla/MoBuildbotTimings</a>
</div>


<script type="application/javascript">


importScript(['modevlib/gui/GUI.js', 'js/util.js', 'modevlib/Dimension-Jobs.js' ], function(){

	var current_run = null;
	var since = Date.now().subtract(Duration.WEEK).unix();

	var __main = function*(this_run){

		current_run = this_run;
		$("#details").html("");

		var pool = GUI.state.pool.makeFilter();
		var platform = GUI.state.platform.makeFilter();
		var product = GUI.state.product.makeFilter();
		var suite = GUI.state.suite.makeFilter();

		var focusFilter = {"and": [
			pool,
			platform,
			product,
			suite,
			{"gt": {"action.start_time": since}}
		]};


		var all_steps = null;

		var a = Log.action("find steps", true);
		try {
			var result = yield (search({
				"select": [
					{"value": "order", "aggregate": "average"},
					{"aggregate": "count"}
				],
				"edges": [
					{
						"name": "step",
						"value": ["builder.step", "harness.step"]
					}
				],
				"from": "jobs.action.timings",
				"where": focusFilter,
				"limit": 1000,
				"format": "list"
			}));
			all_steps = result.data;
		} catch (e) {
			Log.error("Find steps", e);
		} finally {
			Log.actionDone(a);
		}//try

		if (all_steps.length==0){
			if (current_run==this_run){
				$("#details").html("No data");
				yield (null);
			}//endif
		}//endif

		// DETERMINE THE MOST POPULAR STEPS
		var populous = Qb.sort(all_steps, {"value": "count", "sort": -1});
		var population = populous[0].count;
		var stop = 0;
		populous.forall(function(v, i){
			if (stop == 0 && i > 0 && v.count * 10 < population){
				stop = i;
			}//endif
		});
		populous=populous.slice(0, stop);

		var steps = Qb.sort(populous, "order");

		Thread.run(function*(){
			//PULL THE AVERAGE TIME FOR EACH STEP
			var step_timings=null;

			var a = Log.action("find durations", true);
			try {
				var result = yield (search({
					"select": [
						{"value": "order", "aggregate": "average"},
						{"name":"b_duration", "value": "builder.duration", "aggregate": "average"},
						{"name":"h_duration", "value": "harness.duration", "aggregate": "average"},
						{"aggregate":"count"}
					],
					"groupby": ["builder.step", "harness.step"],
					"from": "jobs.action.timings",
					"where": {"and": [
						focusFilter,
						{"or": steps.select("step").map(function(v){
							if (v[1]){
								return {"eq": {"builder.step": v[0], "harness.step": v[1]}};
							}else{
								return {"and":[
									{"eq": {"builder.step": v[0]}},
									{"missing":"harness.step"}
								]};
							}//endif
						})}
					]},
					"limit": 1000,
					"format": "list"
				}));
				step_timings = result;
			} catch (e) {
				Log.error("Find steps", e);
			} finally {
				Log.actionDone(a);
			}//try

			step_timings.data = Qb.sort(step_timings.data, "order");
			step_timings.data.forall(function(v, i){
				//DO NOT SHOW BUILDER STEP THAT HAS HARNESS SUB-STEPS (TO MINIMIZE CONFUSION)
				next = step_timings.data[i+1];
				if (next && next.harness && !v.harness){
					v.b_duration=null;
				}//endif

				//FORMAT STEP
				v.step = v.builder.step;
				if (v.harness) {
					v.step = v.step + "::" + v.harness.step;
				}//endif

				//COALESCE DURATION
				v.duration = coalesce(aMath.round(v.h_duration, 0), aMath.round(v.b_duration, 0));
			});

			//ONLY SHOW step AND duration
			step_timings.header = [
				{"name": "step"},
				{"name": "duration"}
			];

			if (current_run==this_run) {
				$("#details").html(convert.List2HTMLTable(step_timings));
			}//endif

			yield (null);
		});

		Thread.run(function*(){
			//SHOW TIMES OVER PAST FEW WEEKS


		});


		yield (null);
	};


	Thread.showWorking = function(numThread){
		var l = $(".loading");
		l.show();
	};//function

	Thread.hideWorking = function(){
		var l = $(".loading");
		l.hide();
	};//function


	var thread;
	var main = function(){
		if (thread !== undefined)
			thread.kill();
		thread = Thread.run(__main());
	};

	$(document).ready(function(){
		GUI.setup(main, [
			{"id":"sampleMin", "name":"Start Date", "type":"time", "default":Date.eod().add("-18week")},
			{"id":"sampleMax", "name":"End Date", "type":"time", "default":Date.today().ceilingWeek()},
			{"id":"sampleInterval", "name":"Interval", "type":"duration", "default":"week"},
			{"id": "pool", "name": "Pool", "type": PartitionFilter.newInstance({
				"id": "pool",
				"name": "pool",
				"dimension": Mozilla.Timings.Pool,
				"onlyOne": true,
				"expandAll": true
			})},
			{"id": "platform", "name": "Platform", "type": PartitionFilter.newInstance({
				"id": "platform",
				"name": "platform",
				"dimension": Mozilla.Timings.Platform,
				"onlyOne": true,
				"expandAll": true
			})},
			{"id": "product", "name": "Product", "default":"firefox", "type": PartitionFilter.newInstance({
				"id": "product",
				"name": "product",
				"dimension": Mozilla.Timings.Product,
				"onlyOne": true,
				"expandAll": true
			})},
			{"id": "suite", "name": "Suite", "type": PartitionFilter.newInstance({
				"id": "suite",
				"name": "suite",
				"dimension": Mozilla.Timings.Suite,
				"onlyOne": true,
				"expandAll": true
			})}
		],
		[
//			"if (Date.newInstance(sampleMax).subtract(Date.newInstance(sampleMin)).round(Duration.WEEK, 0)>=5) sampleInterval='week'",
//			"if (Date.newInstance(sampleMax).subtract(Date.newInstance(sampleMin)).round(Duration.WEEK, 0)<=3) sampleInterval='day'",
			"sampleMin=Date.newInstance(sampleMin).floor(Duration.newInstance(sampleInterval)).format('yyyy-MM-dd')",
			"sampleMax=Date.newInstance(sampleMax).addDay(1).floor(Duration.newInstance(sampleInterval)).addDay(-1).format('yyyy-MM-dd')"
		],
		"timings",
		false		//SHOW DEFAULT FILTERS?
		);
	});


});




</script>


</BODY>
</HTML>

