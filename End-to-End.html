<!DOCTYPE html>
<HTML lang="en">
<HEAD>
    <title>End to End Times</title>
    <script type="text/javascript" src="modevlib/imports/import.js"></script>
    <link type="text/css" rel="stylesheet" href="css/menu.css"/>
</HEAD>
<BODY>
<!--Click on series to get scatter plot of all times-->
<!--Click on point to get TH and logs-->


<div id="sidebar" layout="tl=window.tl;bottom=footer.bottom;" style="width:0;overflow:hidden;">
    <div id="description" style="padding-left:10px;">
        <h3>About</h3>
        Show the longest build/test times. All times showing the 90th percentile, the aggregate is a synthetic sum.
    </div>
    <hr>
    <div id="last-updated" style="text-align: center;width:300px;"></div>
    <hr>
    <div id="filters" style="width:300px;" class="menu">
    </div>
    <div id="parameters">
    </div>
</div>
<div id="sidebar_name" class="sidebar_name" layout="top=window.top;bottom=footer.top;left=sidebar.right;">
    <div>Configuration</div>
</div>
<div id="content" class="content" layout="tr=page.tr;left=sidebar_name.right;bottom=footer.top;" style="padding: 10px 10px 50px 10px;">
    <h1 id="title">End-to-End Times</h1>
    <span id="status" style="height:30px">Page Loading...</span><span class="loading"><img src="images/spinner.gif" alt=""></span>

    <div id="chart_area" layout="br=content.bc;tl=title.bl;">Please Wait</div>
    <div id="chart_area2" layout="br=content.br;tl=chart_area.tr;"></div>
</div>
<div id="footer" style="height:50px;text-align: center;padding: 5px 0 5px 0;background-color: #fff;z-index: 12;" layout="bl=window.bl;br=window.br;">
    Source at <a href="https://github.com/mozilla/MoBuildbotTimings">https://github.com/mozilla/MoBuildbotTimings</a><br>
    Wiki <a href="https://wiki.mozilla.org/Auto-tools/Projects/DevelopmentMetrics">https://wiki.mozilla.org/Auto-tools/Projects/DevelopmentMetrics</a>
</div>

<div id="row_template" style="visibility:hidden;">
    <div style="padding:10px 20px 10px 20px;">
        <h4>{{TITLE}}</h4>
        <div id="chartseries{{ROWNUM}}" class="chart" style="display: inline-block;"></div>
        <div id="chart{{ROWNUM}}" class="chart" style="display: inline-block;"></div>
    </div>
</div>


<script type="application/javascript">


importScript([
    'modevlib/main.js',
    'js/util.js',
    'modevlib/layouts/layout.js',
    'modevlib/charts/cccChart.js',
    'modevlib/Dimension-Builds.js',
    'js/gantt.js',
    'js/test_data.js'
], function(){
    var NUM_TESTS = 5;
    var BAR_HEIGHT = 20;

    layoutAll();
    sidebarSlider();

    var thread;
    var createChart = function(){
        if (thread !== undefined)
            thread.kill();
        thread = Thread.run(__createChart());
    };

    var __createChart = function*(){
        var beginPastWeek = Date.today().add("-week");
        var beginPastMonth = Date.newInstance(GUI.state.sampleMin);
        var endPastMonth = Date.newInstance(GUI.state.sampleMax);
        var mainFilter = {
            "and": [
                {
                    "eq": {
                        "build.product": "firefox",
                        "action.buildbot_status": "success"
                    }
                },
                {
                    "or": [
                        {"missing": "build.type"},
                        {"in": {"build.type": ["pgo", "debug"]}}
                    ]
                },
                {"in": {"build.branch": ["mozilla-inbound", "try"]}}
            ]
        };

        <!--Split by build type (std, debug, opt) over (try and inbound)-->
        <!--Show with/without wait times-->
        <!--List top 5 longest run tests (dropdown for more?)-->

        <!--Click to show timeline for that category of test, including all steps-->
        <!--(highlight step when hovering)-->

        // GRAB ALL BUILD TIMES FROM THE PAST WEEK
        //


        //SUMMARY OF BUILD TIMES SINCE minDate
        var build_averages = null;
        var test_averages = null;

        var build_thread = Thread.run("build times", function*(){
            var a = Log.action("Get build times", true);

            var query = {
                "from": "jobs",
                "select": [
                    {
                        "name": "wait_time",
                        "value": {"sub": ["action.start_time", "action.request_time"]},
                        "aggregate": "percentile", "percentile":0.90
                    },
                    {
                        "name": "duration",
                        "value": "action.duration",
                        "aggregate": "percentile", "percentile":0.90
                    },
                    {
                        "name": "end_time",
                        "value": {"sub": ["action.end_time", "action.request_time"]},
                        "aggregate": "percentile", "percentile":0.90
                    }
                ],
                "edges": [
                    {
                        "name": "Platform",
                        "allowNulls": false,
                        "domain": Mozilla.Builds.Platform.getActiveDataDomain()
                    },
                    {
                        "name": "Type",
                        "allowNulls": false,
                        "domain": Mozilla.Builds.Type.getActiveDataDomain()
                    }
                ],
                "where": {
                    "and": [
                        {"eq": {"action.type": "build"}},
                        mainFilter,
                        {"gt": {"action.start_time": beginPastWeek.unix()}}
                    ]
                },
                "limit": 1000
            };

            try {
                build_averages = yield (search(query));
            } catch (e) {
                Log.error("problem with call to ActiveData", e)
            } finally {
                Log.actionDone(a);
            }//try
        });


        var tests_thread = Thread.run("test times", function*(){
            var a = Log.action("Get test times", true);

            var query = {
                "from": "jobs",
                "select": [
                    {
                        "name": "wait_time",
                        "value": {"sub": ["action.start_time", "action.request_time"]},
                        "aggregate": "percentile", "percentile":0.90
                    },
                    {
                        "name": "duration",
                        "value": "action.duration",
                        "aggregate": "percentile", "percentile":0.90
                    },
                    {
                        "name": "end_time",
                        "value": {"sub": ["action.end_time", "action.request_time"]},
                        "aggregate": "percentile", "percentile":0.90
                    }
                ],
                "edges": [
                    {
                        "name": "Platform",
                        "allowNulls": false,
                        "domain": Mozilla.Builds.Platform.getActiveDataDomain()
                    },
                    {
                        "name": "Type",
                        "allowNulls": false,
                        "domain": Mozilla.Builds.Type.getActiveDataDomain()
                    },
                    {
                        "name": "suite",
                        "value": "run.suite"
                    }
                ],
                "where": {
                    "and": [
                        {"eq": {"action.type": "test"}},
                        mainFilter,
                        {"gt": {"action.start_time": beginPastWeek.unix()}}
                    ]
                },
                "limit": 1000
            };

            try {
                test_averages = yield (search(query));
            } catch (e) {
                Log.error("problem with call to ActiveData", e)
            } finally {
                Log.actionDone(a);
            }//try
        });

        yield Thread.join(build_thread);
        yield Thread.join(tests_thread);

        //SHOW THE (MAX) END-TO-END TIMES BY PLATFORM
        var build_wait_times = new Matrix({"data": build_averages.data.wait_time});
        var build_durations = new Matrix({"data": build_averages.data.duration});
        var build_end_times = new Matrix({"data": build_averages.data.end_time});
        var test_wait_times = new Matrix({"data": test_averages.data.wait_time});
        var test_durations = new Matrix({"data": test_averages.data.duration});
        var test_end_times = new Matrix({"data": test_averages.data.end_time});

        var actions = [];
        build_durations.forall(function(build_duration, c){
            var build_wait_time = build_wait_times.get(c);
            var build_end_time = build_end_times.get(c);
            var total = build_wait_time + build_duration;
            var platform = build_averages.edges[0].domain.partitions[c[0]];
            var type = build_averages.edges[1].domain.partitions[c[1]];
            var buildName = platform.name + (type.name ? " (" + type.name + ")" : "");

            var build_details = {
                "build_name": buildName,
                "build_request_time": 0,
                "build_start_time": build_wait_time / (total / build_end_time),
                "build_wait_time": build_wait_time,
                "build_end_time": build_end_time,
                "build_duration": build_duration / (total / build_end_time),
                "tests": []
            };

            build_details.tests = test_averages.edges[2].domain.partitions
                .map(function(part, i){
                    var tc = [c[0], c[1], i];

                    var test_duration = test_durations.get(tc);
                    if (test_duration == null) return;
                    var test_wait_time = test_wait_times.get(tc);
                    var test_end_time = test_end_times.get(tc);
                    var total = test_wait_time + test_duration;

                    return {
                        "test_name": part.name,
                        "test_request_time": build_end_time,
                        "test_wait_time": test_wait_time,
                        "test_start_time": build_end_time + test_wait_time / (total / test_end_time),
                        "test_end_time": build_end_time + test_end_time,
                        "test_duration": test_duration
                    };
                })
                .filter({"exists": "."})
                .orderBy({"test_end_time": "desc"})
            ;
            build_details.tests.forall(function(t, i){t.index=i;});

            var longTest = coalesce(build_details.tests[0], {});
            build_details.test_end_time = coalesce(longTest.test_end_time, build_details.build_end_time);
            actions.append(build_details);
        });
        actions = actions.filter({"gt":{"test_end_time":0}}).orderBy({"test_end_time": "desc"});

        Log.note(convert.value2json(actions));

//        var actions = getAllActions();

        var all_actions = [];
        var build_actions = [];  //Index for all builds
        var test_actions = {};   //index all tests for all builds
        actions.forall(function(b){
            var bi = all_actions.length;
            all_actions.append(b);
            b.index = bi;
            build_actions.append(bi);
            test_actions[bi]=[];
            b.tests.forall(function(t, ti){
                if (ti==0){
                    Map.setDefault(b, t);  // MERGE WITH THE BUILD RECORD
                }else{
                    var ai = all_actions.length;
                    all_actions.append(t);
                    test_actions[bi].append(ai);
                    t.index=ai;
                }
            });
        });

        $("#chart_area").height(build_actions.length * BAR_HEIGHT);

        var chart = gantt({
            "target": "chart_area",
            "data": all_actions,
            "style": {"height": build_actions.length * BAR_HEIGHT},
            "axis": {
                "x": {
                    "label": "Time",
                    "format": "hh:mm:ss"
                },
                "y": {
                    "type":"set",
                    "label": "Step",
                    "domain": {"partitions": build_actions}
                }
            },
            "series": [
                {
                    "name":"Build Wait Time",
                    "label": "wait",
                    "type": "gantt",
                    "style": {
                        "color":"#7f7f7f",
                        "style":{"bar-spacing":"20%"}
                    },
                    "select": [
                        {"name": "x", "range": {"min": "build_request_time", "max": "build_start_time"}},
                        {"name": "y", "value": "index"}
                    ],
                    "tip": {
                        "format": 'Build Wait Time<br>Duration = {{build_wait_time|format("H:mm:ss")}}'
                    }

                },
                {
                    "name":"Build Duration",
                    "label": "{{build_name}}",
                    "type": "gantt",
                    "select": [
                        {"name": "x", "range": {"min": "build_start_time", "max": "build_end_time"}},
                        {"name": "y", "value": "index"}
                    ],
                    "tip": {
                        "format": '{{build_name}}<br>Duration = {{build_duration|format("H:mm:ss")}}'
                    }
                },
                {
                    "name":"Test Wait Time",
                    "label": "wait",
                    "type": "gantt",
                    "style": {"color":"#7f7f7f"},
                    "select": [
                        {"name": "x", "range": {"min": "test_request_time", "max": "test_start_time"}},
                        {"name": "y", "value": "index"}
                    ],
                    "tip": {
                        "format": 'Test Wait Time<br>Duration = {{test_wait_time|format("H:mm:ss")}}'
                    }
                },
                {
                    "name":"Test Duration",
                    "label": "{{test_name}}",
                    "type": "gantt",
                    "select": [
                        {"name": "x", "range": {"min": "test_start_time", "max": "test_end_time"}},
                        {"name": "y", "value": "index"}
                    ],
                    "tip": {
                        "format": '{{test_name}}<br>Duration = {{test_duration|format("H:mm:ss")}}'
                    }
                }
            ],
            "tip": {
                "format": '{{name}}<br>Duration = {{duration|format("H:mm:ss")}}',
                "style": {
                    "padding": "5px 10px 5px 10px",
                    "position": "absolute",
                    "visibility": "hidden",
                    "background-color": "black",
                    "color": "white",
                    "font-weight": "bold",
                    "align-text": "center"
                }
            },
            "click": showTests
        });

        function showTests(data){
            // CHEAT BY MANIPULATING THE DOMAIN TO SHOW MORE, OR LESS
            var old_domain = chart.axis.y.domain._scale.domain();

            var domain = build_actions;
            domain = qb.sort(Array.UNION([domain, data.tests.select("index")]), ".");
            if (domain.subtract(old_domain).length==0) domain = build_actions;
            chart.axis.y.domain._scale.domain(domain);
            chart.style.height = domain.length * BAR_HEIGHT;
            dynamicLayout();
        }
        dynamicLayout();

        yield (null);
    };

    Thread.showWorking = function(numThread){
        var l = $(".loading");
        l.show();
    };//function

    Thread.hideWorking = function(){
        var l = $(".loading");
        l.hide();
    };//function

    $(document).ready(function(){
        GUI.setup(createChart, [
                {"id": "sampleMin", "name": "Start Date", "type": "time", "default": Date.today().add("-2month")},
                {"id": "sampleMax", "name": "End Date", "type": "time", "default": Date.today()}
            ],
            [],
            "",
            false
        );
    });


});

</script>


</BODY>
</HTML>

