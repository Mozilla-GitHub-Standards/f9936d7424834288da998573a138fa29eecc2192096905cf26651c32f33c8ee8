<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<!-- This Source Code Form is subject to the terms of the Mozilla Public
   - License, v. 2.0. If a copy of the MPL was not distributed with this
   - file, You can obtain one at http://mozilla.org/MPL/2.0/. -->
<HTML>
<HEAD>
	<script type="text/javascript" src="modevlib/imports/import.js"></script>
    <link type="text/css" rel="stylesheet" href="css/menu.css"/>
</HEAD>
<BODY>


<div id="sidebar" layout="tl=window.tl;bottom=footer.bottom;" style="width:0;overflow:hidden;">
	<div id="description" style="padding-left:10px;">
		<h3>About</h3>
		An overview of current build times.  Click on a chart of a timeseries view.
	</div>
	<hr>
	<div id="last-updated" style="text-align: center;width:300px;"></div>
	<hr>
	<div id="filters" style="width:300px;" class="menu">
	</div>
	<div id="parameters">
	</div>
</div>
<div id="sidebar_name" class="sidebar_name" layout="top=window.top;bottom=footer.top;left=sidebar.right;">
	<div>Configuration</div>
</div>
<div class="content" layout="top=page.top;left=sidebar_name.right;right=window.right;" style="padding: 10px 10px 50px 10px;">
	<div id="header">
		<h1 id="title" style="display: inline-block;">Firefox win64 Build Times</h1>
		<span id="status" style="height:30px">Page Loading...</span>
		<span class="loading"><img src="images/spinner.gif" alt=""></span>
	</div>
	<div id="breakdown">
		<div id="chart_area" class="chart" style="width:800px;height:400px;">Please Wait</div>
		<div id="details" layout="top=..top;left=chart_area.right;bottom=footer.top;">
		</div>
		<div id="raw_activedata" class="code" style="height:400px;border: 1px solid black; overflow: scroll;" layout="top=..top;left=details.right;right=window.right;"></div>
		<div id="timeline" style="width:800px;height:200px;"></div>
	</div>
</div>
<div id="footer" style="height:50px;text-align: center;padding: 5px 0 5px 0;background-color: #fff;z-index: 12;" layout="bl=window.bl;br=window.br;">
	Source at <a href="https://github.com/mozilla/MoBuildbotTimings">https://github.com/mozilla/MoBuildbotTimings</a><br>
	Wiki <a href="https://wiki.mozilla.org/Auto-tools/Projects/DevelopmentMetrics">https://wiki.mozilla.org/Auto-tools/Projects/DevelopmentMetrics</a>
</div>



<script type="application/javascript">
importScript([
	'modevlib/main.js',
	'js/util.js',
	'modevlib/layouts/layout.js',
	'modevlib/charts/mgChart.js',
	'modevlib/Dimension-Builds.js'
], function(){
	layoutAll();
	sidebarSlider();

	var DETAIL = new Template([
		'<div style="border:1px solid gray">'+
		'<table id="properties">',
		'<tr><td colspan="2"><b>{{status|upper}}</b></td></tr>',
		'<tr><td style="text-align: right;"><b>Branch :</b></td><td style="text-align: left;padding-left:1em;">{{branch}}</td></tr>',
		'<tr><td style="text-align: right;"><b>Revision :</b></td><td class="code" style="text-align: left;padding-left:1em;">{{revision|left(12)}}</td></tr>',
		'<tr><td style="text-align: right;"><b>Start Time :</b></td><td style="text-align: left;padding-left:1em;">{{start|format("MMM dd, HH:mm")}}</td></tr>',
		'<tr><td style="text-align: right;"><b>Duration :</b></td><td style="text-align: left;padding-left:1em;">{{duration|round(3)}} minutes</td></tr>',
		'<tr><td colspan="2"><hr></td></tr>',
		'<tr><td colspan="2" style="text-align: right"><a class="button" href="#" onClick="window.open(\'https://treeherder.mozilla.org/#/jobs?repo={{branch}}&revision={{revision}}\')">Go to Treeherder</a></td></tr>',
		'</table>',
		'</div>'
	]);

	var thread;
	var createChart = function(){
		if (thread !== undefined)
			thread.kill();
		thread = Thread.run(__createChart());
	};

	var __createChart = function*(){
		var startOfWeek = Date.today().subtract(Duration.WEEK);
		var startTime = Date.today().subtract(Duration.WEEK);
//		var startTime = Date.today().subtract(Duration.MONTH.multiply(2));
		var platform = "win64";

		var totalsFilter = {"and":[
			{"eq": {
				"action.type": "build",
				"build.product": "firefox",
				"build.platform": platform
			}},
			{"missing": "build.type"}
		]};

		//SUMMARY OF BUILD TIMES SINCE minDate
		var query = {
			"from": "jobs",
			"select": {"aggregate":"count"},
			"where": {
				"and": [
					totalsFilter,
					{"gt": {"action.start_time": startTime.unix()}}
				]
			},
			"limit": 1000
		};
		var a=Log.action("Get summary", true);
		try {
			var count = yield (search(query));
		}catch (e){
			Log.error("problem with call to ACtiveData", e)
		}finally{
			Log.actionDone(a);
		}//try

		a = Log.action("Loading "+count.data.count+" builds", true);
		try{
			var details = yield (search({
				"from":"jobs",
				"select":[
					{"name":"start", "value":"action.start_time"},
					{"name":"status", "value":"action.buildbot_status"},
					{"name":"duration", "value":{"div":{"action.duration": 60}}},
					{"name":"branch", "value":"build.branch"},
					{"name":"revision", "value":"build.revision"},
					{"name":"pool", "value":"run.machine.pool"}
				],
				"where": {
					"and": [
						totalsFilter,
						{"gt": {"action.start_time": startTime.unix()}}
					]
				},
				"format": "list",
				"limit": 100000
			}))
		}finally{
			Log.actionDone(a);
		}//try

		details.data.forall(function(d){
			d.start=Date.newInstance(d.start);
		});


		$("#chart_area").html("");
		aChart.showScatter({
			"target": "chart_area",
			"hover":{"format": "{{duration|round(3)}}minutes"},
			"data": details.data,
			"series":[
				{
					"name": "Branch",
					"value": {
						"when": {"eq": {"status": "success"}},
						"then": "branch",
						"else": "success"
					},
					"axis":"color"
				}
			],
			"axis": {
				"x": {
					"value":"start",
					"format":"{{.|format('NNN dd, HH:mm')}}",
					"size": 50
				},
				"y": {
					"value":"duration",
					"range":{
						"max": aChart.maxNice(details.data.select("duration"))
					}
				},
				"color": {
					"missing": {"style": {"color": "red"}},
					"domain": {
						"type": "set",
						"partitions": Array.union(details.data.select("branch"))
					}
				}
			},
			"click": function(d){
				clickDetails(d, totalsFilter)
			}
		});
	};//function

	function clickDetails(d, totalsFilter){

		$('#details').html(DETAIL.expand(d));
		layoutAll();

		Thread.run(function*(){
			$("#raw_activedata").html("");
			var a = Log.action("get timings", true)
			try {
				var details = yield (search({
					"from": "jobs",
					"where": {
						"and": [
							{"eq": (d.revision ? {"build.revision": d.revision} : {"action.start_time": d.start.unix()})},
							{
								"eq": {
									"build.branch": d.branch
								}
							},
							totalsFilter
						]
					},
					"format": "list",
					"limit": 100
				}));
			}finally{
				Log.actionDone(a);
			}//try

			var action = details.data[0].action;
			var timings = Qb.sort(action.timings, "order");
			action.timings = timings;
			$("#raw_activedata").html(convert.String2HTML(convert.value2json(Array.unwrap(details.data))));

			var width = 800;
			var colors = aChart.STYLES.select("color");


//			var xScale = scale.domain(action.start_time, action.end_time).range(0, width);
			var xScale = d3.scale.linear().domain([action.start_time, action.end_time]).range([20, width-40]);

			function start(d){
				return xScale(coalesce(Map.get(d, "harness.start_time"), Map.get(d, "builder.start_time")));
			}
			function end(d){
				return xScale(coalesce(Map.get(d, "harness.end_time"), Map.get(d, "builder.end_time")));
			}
			function duration(d){
				return end(d)-start(d);
			}
			function level(d){
				return (Map.get(d, "harness.start_time") ? 1 : 0)
			}

			var BORDER=2;
			var HEIGHT = 30;
			var LINE_PADDING = 10;

			function yLine(d){
				return LINE_PADDING + (HEIGHT + LINE_PADDING) * level(d);
			}


			d3.select("#timeline").selectAll("*").remove();

			var svg = d3.select("#timeline")
				.append("svg")
				.width(width)
				.height(200)
				;



			var e = svg.selectAll("rect").data(timings).enter();

			e.append("rect") //SHOW BAR
				.x(start)
				.y(yLine)
				.width(duration)
				.height(HEIGHT)
				.fill(function(d, i){return colors[i%colors.length];})
				.on("mouseover", function(){
					return tip.style({
						"top": d3.event.pageX+"px",
						"left": d3.event.pageY+"px",
						"visibility": "visible"
					});
				})
				.on("mousemove", function(){
					return tip.style({
						"top": d3.event.pageX+"px",
						"left": d3.event.pageY+"px"
					});
				})
				.on("mouseout", function(){
					return tip.style("visibility", "hidden");
				})
			;
			e.append("rect")  //SHOW TIME MARKERS
				.x(function(d){return start(d)-0.5;})
				.y(function(d){return yLine(d)-5;})
				.width(1)
				.height(HEIGHT+10)
				.fill("black")
			;
			e.append("svg")  //SHOW NAME OF EACH STEP (CLIP TO svg)
				.x(function(d){return start(d)+BORDER})
				.y(function(d){return yLine(d)+BORDER})
				.width(function(d){
					return Math.max(0, duration(d) - BORDER - BORDER)
				})
				.height(HEIGHT - BORDER - BORDER)
				.append("text")
				.text(function(d){
					return coalesce(Map.get(d, "harness.step"), d.builder.step);
				})
				.y(HEIGHT - (BORDER*3))
				.fill('black')
			;

			e.append("g")  //SHOW START TIMES FOR EACH STEP
				.translate(5, -15)
				.rotate(45)
				.translate(
					function(d){
						return start(d) + BORDER
					},
					function(d){
						return yLine(d) + HEIGHT + BORDER
					}
				)
				.append("text")
				.text(function(d){
					if (duration(d)< 20 || level(d)==0) return "";
					var s = coalesce(Map.get(d, "harness.start_time"), Map.get(d, "builder.start_time"));
					return Duration.newInstance(1000*(s-action.start_time)).format("HH:mm:ss");
				})
				.y(HEIGHT - (BORDER*3))
				.fill('black')
			;

			(function(d){
				svg.append("g")  //SHOW end_time
					.translate(5, -15)
					.rotate(45)
					.translate(end(d) + BORDER, yLine(d) + HEIGHT + BORDER)
					.append("text")
					.text(Duration.newInstance(1000*(action.end_time-action.start_time)).format("HH:mm:ss"))
					.y(HEIGHT - (BORDER*3))
					.fill('black')
				;


			})(timings.last());


		});




	}


	var tip = d3.select("body").append("div").attr("id", "tip").style({
		"position": "absolute",
		"visibility": "hidden",
		"background-color":"black",
		"font-color": "white",
		"font-weight": "bold"
	}).html("this is a test");



	var proto = d3.selection.prototype;
	["x", "y", "width", "height"].forall(function(name){
		proto[name]=function(){
			return proto.attr.apply(this, [name].appendArray(arguments));
		}
	});
	["fill"].forall(function(name){
		proto[name]=function(){
			return proto.style.apply(this, [name].appendArray(arguments));
		}
	});
	proto.transform=function(){
		return (function(self, name, params){
			return self.each(function(d, i){
				var acc = this.getAttribute("transform");
				var value = name+"("+params.map(function(f){
						return isFunction(f) ?  f(d, i) : f;
					}).join(",")+")";
				this.setAttribute("transform", value+" "+coalesce(acc, ""));
			});
		})(this, arguments[0], Array.prototype.slice.call(arguments, 1));
	};
	["translate", "rotate"].forall(function(name){
		proto[name]=function(){
			return proto.transform.apply(this, [name].appendArray(arguments));
		}
	});


	function scale (v){
		return v;
	}

	(function(){
		function domain(a, b, v){
			return (this(v)-a)/(b-a);
		}
		function range(a, b, v){
			return this(v)*(b-a) + a;
		}

		scale.domain = function(a, b){
			var output = domain.bind(this, a, b);
			output.domain = scale.domain;
			output.range = scale.range;
			return output;
		};
		scale.range = function(a, b){
			var output = range.bind(this, a, b);
			output.domain = scale.domain;
			output.range = scale.range;
		};
	})();




	Thread.showWorking = function(numThread){
		var l = $(".loading");
		l.show();
	};//function

	Thread.hideWorking = function(){
		var l = $(".loading");
		l.hide();
	};//function

	$(document).ready(function(){
		GUI.setup(createChart, [
			],
			[
			],
			"perfy",
			false
		);
	});

});

</script>


</BODY>
</HTML>

