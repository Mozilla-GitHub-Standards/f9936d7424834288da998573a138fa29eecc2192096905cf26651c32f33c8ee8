<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<!-- This Source Code Form is subject to the terms of the Mozilla Public
   - License, v. 2.0. If a copy of the MPL was not distributed with this
   - file, You can obtain one at http://mozilla.org/MPL/2.0/. -->
<HTML>
<HEAD>
	<script type="text/javascript" src="modevlib/imports/import.js"></script>
    <link type="text/css" rel="stylesheet" href="css/menu.css"/>
</HEAD>
<BODY>


<div id="sidebar" layout="tl=window.tl;bottom=footer.bottom;" style="width:0;overflow:hidden;">
	<div id="description" style="padding-left:10px;">
		<h3>About</h3>
		An overview of current build times.  Click on a chart of a timeseries view.
	</div>
	<hr>
	<div id="last-updated" style="text-align: center;width:300px;"></div>
	<hr>
	<div id="filters" style="width:300px;" class="menu">
	</div>
	<div id="parameters">
	</div>
</div>
<div id="sidebar_name" class="sidebar_name" layout="top=window.top;bottom=footer.top;left=sidebar.right;">
	<div>Configuration</div>
</div>
<div class="content" layout="top=page.top;left=sidebar_name.right;right=window.right;" style="padding: 10px 10px 50px 10px;">
	<div id="header">
		<h1 id="title" style="display: inline-block;">Firefox win64 Build Times</h1>
		<span id="status" style="height:30px">Page Loading...</span>
		<span class="loading"><img src="images/spinner.gif" alt=""></span>
	</div>
	<div id="breakdown">
		<div id="chart_area" class="chart" style="width:800px;height:400px;">Please Wait</div>
		<div id="details" layout="top=..top;left=chart_area.right;bottom=footer.top;">
		</div>
		<div id="raw_activedata" class="code" style="height:400px;border: 1px solid black; overflow: scroll;" layout="top=..top;left=details.right;right=window.right;"></div>
	</div>
</div>
<div id="footer" style="height:50px;text-align: center;padding: 5px 0 5px 0;background-color: #fff;z-index: 12;" layout="bl=window.bl;br=window.br;">
	Source at <a href="https://github.com/mozilla/MoBuildbotTimings">https://github.com/mozilla/MoBuildbotTimings</a><br>
	Wiki <a href="https://wiki.mozilla.org/Auto-tools/Projects/DevelopmentMetrics">https://wiki.mozilla.org/Auto-tools/Projects/DevelopmentMetrics</a>
</div>



<script type="application/javascript">
importScript([
	'modevlib/main.js',
	'js/util.js',
	'modevlib/layouts/layout.js',
	'modevlib/charts/mgChart.js',
	'modevlib/Dimension-Builds.js'
], function(){
	layoutAll();
	sidebarSlider();

	var DETAIL = new Template([
		'<div style="border:1px solid gray">'+
		'<table id="properties">',
		'<tr><td colspan="2"><b>{{status|upper}}</b></td></tr>',
		'<tr><td style="text-align: right;"><b>Branch :</b></td><td style="text-align: left;padding-left:1em;">{{branch}}</td></tr>',
		'<tr><td style="text-align: right;"><b>Revision :</b></td><td class="code" style="text-align: left;padding-left:1em;">{{revision|left(12)}}</td></tr>',
		'<tr><td style="text-align: right;"><b>Start Time :</b></td><td style="text-align: left;padding-left:1em;">{{start|format("MMM dd, HH:mm")}}</td></tr>',
		'<tr><td style="text-align: right;"><b>Duration :</b></td><td style="text-align: left;padding-left:1em;">{{duration|round(3)}} minutes</td></tr>',
		'<tr><td colspan="2"><hr></td></tr>',
		'<tr><td colspan="2" style="text-align: right"><a class="button" href="#" onClick="window.open(\'https://treeherder.mozilla.org/#/jobs?repo={{branch}}&revision={{revision}}\')">Go to Treeherder</a></td></tr>',
		'</table>',
		'</div>'
	]);

	var thread;
	var createChart = function(){
		if (thread !== undefined)
			thread.kill();
		thread = Thread.run(__createChart());
	};

	var __createChart = function*(){
		var startOfWeek = Date.today().subtract(Duration.WEEK);
		var startTime = Date.today().subtract(Duration.WEEK);
//		var startTime = Date.today().subtract(Duration.MONTH.multiply(2));
		var platform = "win64";

		var totalsFilter = {"and":[
			{"eq": {
				"action.type": "build",
				"build.product": "firefox",
				"build.platform": platform
			}},
			{"missing": "build.type"}
		]};

		//SUMMARY OF BUILD TIMES SINCE minDate
		var query = {
			"from": "jobs",
			"select": {"aggregate":"count"},
			"where": {
				"and": [
					totalsFilter,
					{"gt": {"action.start_time": startTime.unix()}}
				]
			},
			"limit": 1000
		};
		var a=Log.action("Get summary", true);
		try {
			var count = yield (search(query));
		}catch (e){
			Log.error("problem with call to ACtiveData", e)
		}finally{
			Log.actionDone(a);
		}//try

		a = Log.action("Loading "+count.data.count+" builds", true);
		try{
			var details = yield (search({
				"from":"jobs",
				"select":[
					{"name":"start", "value":"action.start_time"},
					{"name":"status", "value":"action.buildbot_status"},
					{"name":"duration", "value":{"div":{"action.duration": 60}}},
					{"name":"branch", "value":"build.branch"},
					{"name":"revision", "value":"build.revision"}
				],
				"where": {
					"and": [
						totalsFilter,
						{"gt": {"action.start_time": startTime.unix()}}
					]
				},
				"format": "list",
				"limit": 100000
			}))
		}finally{
			Log.actionDone(a);
		}//try

		details.data.forall(function(d){
			d.start=Date.newInstance(d.start);
		});


		$("#chart_area").html("");
		aChart.showScatter({
			"target": "chart_area",
			"hover":{"format": "{{duration|round(3)}}minutes"},
			"data": details.data,
			"series":[
				{
					"name": "Branch",
					"value": {
						"when": {"eq": {"status": "success"}},
						"then": "branch",
						"else": "success"
					},
					"axis":"color"
				}
			],
			"axis": {
				"x": {
					"value":"start",
					"format":"{{.|format('NNN dd, HH:mm')}}",
					"size": 50
				},
				"y": {
					"value":"duration",
					"range":{
						"max": aChart.maxNice(details.data.select("duration"))
					}
				},
				"color": {
					"missing": {"style": {"color": "red"}},
					"domain": {
						"type": "set",
						"partitions": Array.union(details.data.select("branch"))
					}
				}
			},
			"click":function(d){

				$('#details').html(DETAIL.expand(d));
				layoutAll();

				Thread.run(function*(){
					$("#raw_activedata").html("");
					var details = yield (search({
						"from":"jobs",
						"where": {"and": [
							{"eq": (d.revision ? {"build.revision": d.revision} : {"action.start_time": d.start.unix()})},
							{"eq":{
								"build.branch": d.branch
							}},
							totalsFilter
						]},
						"format": "list",
						"limit": 100
					}));
					$("#raw_activedata").html(convert.String2HTML(convert.value2json(Array.unwrap(details.data))));
				});

			}
		});
	};//function

	Thread.showWorking = function(numThread){
		var l = $(".loading");
		l.show();
	};//function

	Thread.hideWorking = function(){
		var l = $(".loading");
		l.hide();
	};//function

	$(document).ready(function(){
		GUI.setup(createChart, [
			],
			[
			],
			"perfy",
			false
		);
	});

});

</script>


</BODY>
</HTML>

